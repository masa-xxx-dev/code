name: GitHub Actions CI

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: GitOps Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

        # ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
      - name: Build an image from Dockerfile
        run: |
          # Dockerãƒ“ãƒ«ãƒ‰
          DOCKER_BUILDKIT=1 docker image build . -f app/Dockerfile --tag ${{ secrets.DOCKERNAME }}/gitops-go-app:${{ github.run_number }}

        # Trivyã«ã‚ˆã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
  with:
        # DOCKERNAMEã‚’ä½¿ç”¨ï¼ˆãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹çµ±ä¸€æ¸ˆã¿ï¼‰
    image-ref: '${{ secrets.DOCKERNAME }}/gitops-go-app:${{ github.run_number }}'
    format: 'table'
    exit-code: '0'
    ignore-unfixed: true
    severity: 'CRITICAL,HIGH'
    
    # ðŸŒŸ è¿½åŠ ä¿®æ­£: Trivyã«Docker Hubã®èªè¨¼æƒ…å ±ã‚’æ¸¡ã™ ðŸŒŸ
    # ã“ã®è¨­å®šã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ã«è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã‚‚èªè¨¼ä»˜ãã§ãƒ—ãƒ«ã‚’è©¦ã¿ã¾ã™ã€‚
    skip-tls-verification: false # é€šå¸¸ã¯false
    username: ${{ secrets.DOCKERNAME }} 
    password: ${{ secrets.DOCKER_PASSWORD }} # ã¾ãŸã¯ DOCKER_TOKEN

        # debug
      - name: List local Docker images for debugging
        run: docker images
            
        # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Docker Hubã«ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push image to Docker Hub
        run: |
          # Docker Hub ãƒ­ã‚°ã‚¤ãƒ³
          docker login docker.io --username ${{ secrets.DOCKERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}
        
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
          #docker image push ${{ secrets.DOCKERNAME }}/gitops-go-app:${{ github.run_number }}
          docker push ${{ secrets.DOCKERNAME }}/gitops-go-app:${{ github.run_number }}

        # values.yamlã®æ›´æ–°ã€æ–°è¦ãƒ–ãƒ©ãƒ³ãƒä½œæˆã€ãƒ—ãƒƒã‚·ãƒ¥ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      - name: Update values.yaml & Pull Request to Config Repository
        run: |
          # GitHubãƒ­ã‚°ã‚¤ãƒ³
          echo -e "machine github.com\nlogin ${{ secrets.USERNAME }}\npassword ${{ secrets.GH_PASSWORD }}" > ~/.netrc
          # ã€Œconfigã€ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone https://github.com/${{ secrets.USERNAME }}/config.git
          # values.yamlãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°å‡¦ç†
          cd config/gitops-helm
          git config --global user.email "${{ secrets.EMAIL }}"
          git config --global user.name "${{ secrets.USERNAME }}"
          # æ–°è¦ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
          git branch feature/${{ github.run_number }}
          git checkout feature/${{ github.run_number }}
          # values.yamlã®ã‚¿ã‚°ç•ªå·ã‚’æ›´æ–°
          sed -i 's/tag: [0-9]*/tag: ${{ github.run_number }}/g' values.yaml
          # ãƒ—ãƒƒã‚·ãƒ¥å‡¦ç†
          git add values.yaml
          git commit -m "Update tag ${{ github.run_number }}"
          git push origin feature/${{ github.run_number }}
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
          echo ${{ secrets.PERSONAL_ACCESS_TOKEN }} > token.txt
          gh auth login --with-token < token.txt
          gh pr create  --title "Update Tag ${{ github.run_number }}" --body "Please Merge !!"
